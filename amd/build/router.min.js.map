{"version":3,"sources":["../src/router.js"],"names":["define","$","Log","ajax","notification","self","trackers","registerTracker","tracker","debug","trackerInfo","trackerId","identify","trackPage","heartBeat","setInterval","init","promises","call","methodname","args","done","data","addEventTracking","fail","ex","exception","eventDefArray","length","forEach","trackerDef","trackerType","provider","definition","eDef","testselector","processDefinition","edef","selector","event","on","evt","preventDefault","ddef","type","name","val","trackerPromises","dfd","Deferred","push","processEvent","when","apply","then","off","trigger"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Liquidus Router module. Routes events to trackers.\n *\n * @package   local_liquidus\n * @copyright Copyright (c) 2020 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/log', 'core/ajax', 'core/notification'],\nfunction($, Log, ajax, notification) {\n\n    var self = this;\n\n    self.trackers = [];\n\n    self.registerTracker = function(tracker) {\n        Log.debug('Registering tracker ' + tracker.trackerInfo.trackerId);\n        self.trackers[tracker.trackerInfo.trackerId] = tracker;\n\n        // Send initial tracker events.\n        tracker.identify();\n        tracker.trackPage();\n        if (tracker.heartBeat) {\n            setInterval(tracker.heartBeat, 10000); // Heart beat.\n        }\n    };\n\n    self.init = function() {\n        var promises = ajax.call([\n            {\n                methodname: 'local_liquidus_event_definition', args: {}\n            },\n        ]);\n\n        promises[0].done(function(data) {\n            self.addEventTracking(data);\n        }).fail(function(ex) {\n            notification.exception(ex);\n        });\n    };\n\n    self.addEventTracking = function(eventDefArray) {\n        if (!eventDefArray || eventDefArray.length === 0) {\n            return;\n        }\n\n        Log.debug('Adding event tracking for:');\n        Log.debug(eventDefArray);\n        eventDefArray.forEach((trackerDef) => {\n            const trackerType = trackerDef.provider;\n            trackerDef.definition.forEach((eDef) => {\n                Log.debug('Looking for selector: ' + eDef.testselector);\n                if ($(eDef.testselector).length) {\n                    self.processDefinition(trackerType, eDef);\n                }\n            });\n        });\n    };\n\n    self.processDefinition = function(trackerType, edef) {\n        Log.debug('Adding event handling for custom event: ' + edef.selector + ' -> ' + edef.event);\n        $(edef.selector).on(edef.event, function(evt) {\n            evt.preventDefault();\n\n            Log.debug('Tracking custom event: ' + edef.selector + ' -> ' + edef.event);\n\n            var data = {};\n\n            for (let ddef of edef.data) {\n                Log.debug('Looking for ' + ddef.selector + 'value.');\n                if (ddef.type === 'input') {\n                    data[ddef.name] = $(ddef.selector).val();\n                }\n            }\n            Log.debug('Got these values:');\n            Log.debug(data);\n\n            var trackerPromises = [];\n            for (let trackerId in self.trackers) {\n                if (trackerId !== trackerType) {\n                    continue;\n                }\n                var dfd = $.Deferred();\n                trackerPromises.push(dfd);\n                self.trackers[trackerId].processEvent(dfd, edef.name, data);\n            }\n\n            $.when.apply($, trackerPromises).then(function() {\n                Log.debug('Processed all trackers, proceeding with event.');\n                $(edef.selector).off(edef.event);\n                $(edef.selector).trigger(edef.event);\n            });\n        });\n    };\n\n    return {\n        'init': self.init,\n        'registerTracker': self.registerTracker\n    };\n});\n"],"file":"router.min.js"}